.ORIG X3000

;		  ======================================================================
;XU LY SO THU NHAT======================================================================
	AND R0,R0,#0				
	AND R1,R1,#0
	AND R2,R2,#0
	AND R3,R3,#0
	AND R4,R4,#0
	AND R5,R5,#0
	AND R6,R6,#0
LD R5,KITU1_1					;R5 = X4000
NHAP					
	GETC				
	OUT			
	LD R6,DECTOCHAR				;R6 = #-48	
	ADD R6,R0,R6				;R6 << R0-48
	BRn CHUYENDOI				;NEU LA KI TU DAU THI BAT DAU CHUYENDOI
	STR R6,R5,#0				;R0 >> O NHO R5
	ADD R5,R5,#1				;TANG BIEN O NHO R5
	ADD R3,R3,#1				;TANG BIEN DEM R3
	ADD R6,R3,#-5				;KIEM TRA XEM CO LON HON 5 KI TU KHONG
	BRz MATH_ERROR
	BRnp NHAP				;NHAP LAI

CHUYENDOI
	STI R0,PHEPTINH				;LUU PHEP TINH R0 VAO O NHO X4004
	ADD R4,R3,#-4				;KIEM TRA XEM CO PHAI LA SO CO 4 CHU SO
	BRz CHUYENDOI_4CHUSO			
	ADD R4,R3,#-3				;KIEM TRA XEM CO PHAI LA SO CO 3 CHU SO
	BRz CHUYENDOI_3CHUSO			
	ADD R4,R3,#-2				;KIEM TRA XEM CO PHAI LA SO CO 2 CHU SO
	BRz CHUYENDOI_2CHUSO
	ADD R4,R3,#-1				;KIEM TRA XEM CO PHAI LA SO CO 1 CHU SO
	BRz CHUYENDOI_1CHUSO

	CHUYENDOI_4CHUSO ;______________________;THUC HIEN CHUYEN DOI SO CO 4 CHU SO
		LD  R1,TANG1000			
		LDI R5,KITU1_1			
		TIEPTUCCONG1000_1_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG100_1_4
			BRp TIEPTUCCONG1000_1_4
		CONG100_1_4
		LD R1,TANG100	
		LDI R5,KITU1_2
		TIEPTUCCONG100_1_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG10_1_4
			BRp TIEPTUCCONG100_1_4
		CONG10_1_4
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU1_3
		TIEPTUCCONG10_1_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_1_4
			BRp TIEPTUCCONG10_1_4
		CONG1_1_4
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU1_4
		TIEPTUCCONG1_1_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU1
			BRp TIEPTUCCONG1_1_4

	CHUYENDOI_3CHUSO ;________________________;THUC HIEN CHUYEN DOI SO CO 3 CHU SO		
		LD R1,TANG100	
		LDI R5,KITU1_1
		TIEPTUCCONG100_1_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG10_1_3
			BRp TIEPTUCCONG100_1_3
		CONG10_1_3
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU1_2
		TIEPTUCCONG10_1_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_1_3
			BRp TIEPTUCCONG10_1_3
		CONG1_1_3
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU1_3
		TIEPTUCCONG1_1_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU1
			BRp TIEPTUCCONG1_1_3
	CHUYENDOI_2CHUSO ;________________________;THUC HIEN CHUYEN DOI SO CO 2 CHU SO			
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU1_1
		TIEPTUCCONG10_1_2
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_1_2
			BRp TIEPTUCCONG10_1_2
		CONG1_1_2
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU1_2
		TIEPTUCCONG1_1_2
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU1
			BRp TIEPTUCCONG1_1_2

	CHUYENDOI_1CHUSO ;_________________________;THUC HIEN CHUYEN DOI SO CO 1 CHU SO
		LDI R2,KITU1_1
	HOANTHANH_SOTHU1
	STI R2,ONHO1
	


;		 ======================================================================
;XU LY SO THU HAI======================================================================

	AND R0,R0,#0				
	AND R1,R1,#0
	AND R2,R2,#0
	AND R3,R3,#0
	AND R4,R4,#0
	AND R5,R5,#0
	AND R6,R6,#0
LD R5,KITU2_1					;R5 = X4005
NHAP2					
	GETC				
	OUT			
	LD R6,DAUBANG				;R6 = #-61 " = "
	ADD R6,R0,R6				;R6 << R0-61
	BRzp CHUYENDOI2				;NEU LA KI TU BANG THI BAT DAU CHUYENDOI2
	LD R6,DECTOCHAR				;R6 = #-48
	ADD R6,R6,R0				;R6 << R0 - 48
	STR R6,R5,#0				;R0 >> O NHO R5
	ADD R5,R5,#1				;TANG BIEN O NHO R5
	ADD R3,R3,#1				;TANG BIEN DEM R3
	ADD R6,R3,#-5				;KIEM TRA XEM CO LON HON 5 KI TU KHONG
	BRz MATH_ERROR
	BRnp NHAP2				;NHAP LAI

CHUYENDOI2

;	STI R0,PHEPTINH				;LUU PHEP TINH R0 VAO O NHO X4004

	ADD R4,R3,#-4				;KIEM TRA XEM CO PHAI LA SO CO 4 CHU SO
	BRz CHUYENDOI_4CHUSO_2			
	ADD R4,R3,#-3				;KIEM TRA XEM CO PHAI LA SO CO 3 CHU SO
	BRz CHUYENDOI_3CHUSO_2			
	ADD R4,R3,#-2				;KIEM TRA XEM CO PHAI LA SO CO 2 CHU SO
	BRz CHUYENDOI_2CHUSO_2
	ADD R4,R3,#-1				;KIEM TRA XEM CO PHAI LA SO CO 1 CHU SO
	BRz CHUYENDOI_1CHUSO_2

	CHUYENDOI_4CHUSO_2 ;____________________;THUC HIEN CHUYEN DOI SO CO 4 CHU SO
		LD  R1,TANG1000		
		LDI R5,KITU2_1			
		TIEPTUCCONG1000_2_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG100_2_4
			BRp TIEPTUCCONG1000_2_4
		CONG100_2_4
		LD R1,TANG100	
		LDI R5,KITU2_2
		TIEPTUCCONG100_2_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG10_2_4
			BRp TIEPTUCCONG100_2_4
		CONG10_2_4
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU2_3
		TIEPTUCCONG10_2_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_2_4
			BRp TIEPTUCCONG10_2_4
		CONG1_2_4
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU2_4
		TIEPTUCCONG1_2_4
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU2
			BRp TIEPTUCCONG1_2_4

	CHUYENDOI_3CHUSO_2 ;_______________________;THUC HIEN CHUYEN DOI SO CO 3 CHU SO		
		LD R1,TANG100	
		LDI R5,KITU2_1
		TIEPTUCCONG100_2_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG10_2_3
			BRp TIEPTUCCONG100_2_3
		CONG10_2_3
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU2_2
		TIEPTUCCONG10_2_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_2_3
			BRp TIEPTUCCONG10_2_3
		CONG1_2_3
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU2_3
		TIEPTUCCONG1_2_3
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU2
			BRp TIEPTUCCONG1_2_3
	CHUYENDOI_2CHUSO_2 ;________________________;THUC HIEN CHUYEN DOI SO CO 2 CHU SO			
		AND R1,R1,#0
		ADD R1,R1,#10
		LDI R5,KITU2_1
		TIEPTUCCONG10_2_2
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz CONG1_2_2
			BRp TIEPTUCCONG10_2_2
		CONG1_2_2
		AND R1,R1,#0
		ADD R1,R1,#1
		LDI R5,KITU2_2
		TIEPTUCCONG1_2_2
			ADD R2,R2,R1
			ADD R5,R5,#-1
			BRz HOANTHANH_SOTHU2
			BRp TIEPTUCCONG1_2_2

	CHUYENDOI_1CHUSO_2 ;_________________________;THUC HIEN CHUYEN DOI SO CO 1 CHU SO
		LDI R2,KITU2_1
	HOANTHANH_SOTHU2
	STI R2,ONHO2


;		========================================================================
;BATDAUTINHTOAN ========================================================================

	AND R0,R0,#0				
	AND R1,R1,#0					;BIEN R1 LUU GIA TRI SO THU NHAT
	AND R2,R2,#0					;BIEN R2 LUU GIA TRI SO THU HAI
	AND R3,R3,#0					;BIEN R3 LUU KET QUA PHEP TINH
	AND R4,R4,#0
	AND R5,R5,#0
	AND R6,R6,#0

	LDI R6,PHEPTINH
	LD R5, PHEPCONG
	ADD R4,R5,R6
	BRz PHEPCONG_					;KIEM TRA PHEP CONG
	LD R5,PHEPTRU
	ADD R4,R5,R6
	BRz PHEPTRU_					;KIEM TRA PHEP TRU
	LD R5, PHEPNHAN
	ADD R4,R5,R6		
	BRz PHEPNHAN_					;KIEM TRA PHEP NHAN
	LD R5, PHEPCHIA
	ADD R4,R5,R6
	BRz PHEPCHIA_					;KIEM TRA PHEP CHIA
	LD R5, PHEPCHIALAYDU
	ADD R4,R5,R6
	BRz PHEPCHIALAYDU_				;KIEM TRA PHEP CHIA LAY DU

	  
PHEPCONG_ ;________________________________________________________________
	LDI R1,ONHO1
	LDI R2,ONHO2
	ADD R3,R1,R2
	STI R3,KETQUA
	BRnzp INRAMANHINH


PHEPTRU_  ;________________________________________________________________
	LDI R1,ONHO1
	LDI R2,ONHO2
	NOT R2,R2
	ADD R2,R2,#1
	ADD R3,R1,R2
	STI R3,KETQUA
	BRnzp INRAMANHINH


PHEPNHAN_ ;_________________________________________________________________
	LDI R1,ONHO1
	BRz BANGKHONG
	LDI R2,ONHO2
	BRz BANGKHONG
	TIEPTUCNHAN
		ADD R3,R3,R1
		ADD R2,R2,#-1
		BRp TIEPTUCNHAN
		BRz INRAMANHINH

	BANGKHONG
		AND R3,R3,#0
		BRnzp INRAMANHINH


PHEPCHIA_ ;__________________________________________________________________
	LDI R1,ONHO1
	LDI R2,ONHO2
	BRz MATH_ERROR
	
	NOT R2,R2
	ADD R2,R2,#1

	TIEPTUCCHIA
		ADD R3,R3,#1
		ADD R1,R1,R2
		BRzp TIEPTUCCHIA
	ADD R3,R3,#-1
	BRnzp INRAMANHINH


PHEPCHIALAYDU_ ;______________________________________________________________
	LDI R1,ONHO1
	LDI R2,ONHO2
	LDI R4,ONHO2
	BRz MATH_ERROR
	ADD R3,R1,#0
	NOT R2,R2
	ADD R2,R2,#1
	TIEPTUCCHIALAYDU
		ADD R3,R3,R2
		BRzp TIEPTUCCHIALAYDU
	ADD R3,R3,R4
	BRnzp INRAMANHINH


INRAMANHINH ;______________________________________________________________
	STI R3,KETQUA
	
	HALT
	









MATH_ERROR
	LEA R0,MATHERROR
	PUTS
	MATHERROR .STRINGZ "\n MATH ERROR"
	HALT

KITU1_1	 .FILL X4000
KITU1_2	 .FILL X4001
KITU1_3	 .FILL X4002
KITU1_4	 .FILL X4003
PHEPTINH .FILL X4004
KITU2_1	 .FILL X4005
KITU2_2  .FILL X4006
KITU2_3  .FILL X4007
KITU2_4  .FILL X4008

CHARTODEC .FILL #48
DECTOCHAR .FILL #-48

ONHO1	 .FILL X4009
ONHO2	 .FILL X400A
KETQUA	 .FILL X400B

TRU10000 .FILL #-10000
TRU1000  .FILL #-1000
TRU100   .FILL #-100

TANG1000 .FILL #1000
TANG100  .FILL #100

DAUBANG  .FILL #-61
PHEPCONG .FILL #43
PHEPTRU  .FILL #45
PHEPNHAN .FILL #42
PHEPCHIA .FILL #47
PHEPCHIALAYDU .FILL #37

.END